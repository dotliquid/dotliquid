# Build script for dotliquid, see https://www.appveyor.com/docs/appveyor-yml for reference
version: 2.0.{build}
image: Visual Studio 2017

cache:
  - C:\ProgramData\chocolatey\bin -> appveyor.yml
  - C:\ProgramData\chocolatey\lib -> appveyor.yml

configuration:
  - Release

dotnet_csproj:
  patch: true
  file: '**\*.csproj'
  version: "{version}"
  informational_version: "{version}-$(APPVEYOR_REPO_COMMIT)"

install:
  - cmd: choco install opencover.portable -y
  - cmd: choco install codecov -y
  - cmd: dotnet restore src

build_script:
  - cmd: dotnet build -c Release src/DotLiquid.sln

after_build:
  - cmd: dotnet pack src/DotLiquid/DotLiquid.csproj -c Release --no-build -o ../../build/pkg

test_script:
  - opencover.console -target:"C:\Tools\NUnit3\nunit3-console.exe" -targetargs:"src\DotLiquid.Tests\bin\Release\net461\DotLiquid.Tests.dll --where=cat!=windows --result=TestsResults.xml;format=AppVeyor" -output:TestsCoverage.xml -filter:"+[DotLiquid]*" -register:user -returntargetcode
  - codecov -f TestsCoverage.xml

artifacts:
- path: build\pkg\*.*nupkg
  name: Nuget Package

- path: TestsCoverage.xml

nuget:
  project_feed: true

deploy:
- provider: NuGet
  api_key:
    secure: LrIeQprS+E5FzLkdKGYIYHXy/86Kt8YVhTa4J/VhLzGUO+yXnqI+GxDR+K5Wj/VL
  skip_symbols: false
  artifact: /.*\.*nupkg/
  on:
    branch: master
